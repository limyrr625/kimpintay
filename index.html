<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kimpintay Shield E2EE</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        :root {
            --p: #7b61ff; 
            --g: #ffb800; 
            --bg: #0b0b0e;
        }
        body { 
            background: #050505; color: white; height: 100vh; margin: 0; 
            display: flex; font-family: 'Segoe UI', sans-serif; justify-content: center; align-items: center; 
        }
        .app { 
            width: 95%; max-width: 1000px; height: 85vh; background: #16161e; 
            display: flex; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .side { 
            width: 280px; border-right: 1px solid #222; display: flex; 
            flex-direction: column; background: #111118; 
        }
        .crypto-box { 
            padding: 15px; background: rgba(255,184,0,0.05); border-bottom: 1px solid rgba(255,184,0,0.2); 
        }
        .chat { flex: 1; display: flex; flex-direction: column; background: #0a0a0f; }
        .msg-box { 
            flex: 1; padding: 20px; overflow-y: auto; display: flex; 
            flex-direction: column; gap: 10px; 
        }
        .m { max-width: 75%; padding: 12px 16px; border-radius: 18px; font-size: 15px; line-height: 1.4; }
        .in { background: #22222e; align-self: flex-start; border-bottom-left-radius: 4px; }
        .out { background: #3d266e; align-self: flex-end; border-bottom-right-radius: 4px; }
        
        input { 
            background: #1e1e26; border: 1px solid #333; color: white; 
            padding: 12px; border-radius: 10px; outline: none; width: calc(100% - 24px); 
            margin-bottom: 8px; transition: 0.3s;
        }
        input:focus { border-color: var(--p); }
        button { 
            background: var(--p); border: none; color: white; padding: 10px 20px; 
            border-radius: 12px; cursor: pointer; font-weight: bold;
        }
        .contact { 
            padding: 12px 15px; border-bottom: 1px solid #1a1a25; 
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .contact:hover { background: #1a1a25; }
        .del-btn { color: #ff4444; font-weight: bold; padding: 5px 10px; cursor: pointer; opacity: 0.5; }
        .del-btn:hover { opacity: 1; }
    </style>
</head>
<body>

<div class="app">
    <div class="side">
        <div style="padding: 20px; font-weight: bold; color: var(--p); font-size: 20px;">Kimpintay</div>
        
        <div class="crypto-box">
            <div style="font-size: 10px; color: var(--g); margin-bottom: 5px; letter-spacing: 1px;">КЛЮЧ ШИФРОВАНИЯ:</div>
            <input type="password" id="c-key" placeholder="Придумайте пароль...">
        </div>

        <div style="padding: 15px;" id="login-ui">
            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">ВАШ УНИКАЛЬНЫЙ НИК:</div>
            <input type="text" id="my-id" placeholder="Ник и Enter...">
            <div id="st" style="font-size: 10px; color: #ff4444; margin-top: 5px;">статус: offline</div>
        </div>

        <div id="search-ui" style="padding: 15px; display:none;">
            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">ДОБАВИТЬ ДРУГА:</div>
            <input type="text" id="peer-id" placeholder="Ник друга и Enter...">
            <div style="font-size: 11px; color: #444; margin: 15px 0 5px;">ВАШИ ЧАТЫ:</div>
            <div id="contact-list"></div>
        </div>
    </div>

    <div class="chat">
        <div id="h-name" style="padding: 20px; border-bottom: 1px solid #222; font-weight: bold; color: #eee;">Выберите контакт</div>
        <div class="msg-box" id="box"></div>
        <div style="padding: 20px; display: flex; gap: 10px; background: #0c0c12;">
            <input type="text" id="m-in" placeholder="Зашифрованное сообщение..." style="margin-bottom:0;">
            <button onclick="send()">➤</button>
        </div>
    </div>
</div>

<script>
    let peer, conn, myNick, friends = [];
    const keyInp = document.getElementById('c-key');
    const msgBox = document.getElementById('box');

    function render() {
        const list = document.getElementById('contact-list');
        list.innerHTML = '';
        friends.forEach(f => {
            const d = document.createElement('div');
            d.className = 'contact';
            d.innerHTML = `<span>${f}</span><span class="del-btn" onclick="event.stopPropagation();delFriend('${f}')">×</span>`;
            d.onclick = () => startConnection(f);
            list.appendChild(d);
        });
    }

    function delFriend(f) {
        friends = friends.filter(i => i !== f);
        localStorage.setItem('contacts_' + myNick, JSON.stringify(friends));
        render();
        if (conn && conn.peer === f) {
            document.getElementById('h-name').innerText = "Чат удален";
            msgBox.innerHTML = "";
        }
    }

    document.getElementById('my-id').onkeypress = (e) => {
        if (e.key === 'Enter' && e.target.value) {
            myNick = e.target.value.trim().toLowerCase();
            peer = new Peer(myNick);
            
            peer.on('open', (id) => {
                document.getElementById('st').innerText = "В СЕТИ: " + id;
                document.getElementById('st').style.color = "#00ff88";
                document.getElementById('login-ui').style.display = "none";
                document.getElementById('search-ui').style.display = "block";
                friends = JSON.parse(localStorage.getItem('contacts_' + id)) || [];
                render();
            });

            peer.on('connection', (c) => { conn = c; setupEvents(); });
            peer.on('error', (err) => {
                if(err.type === 'unavailable-id') alert("Ник уже занят!");
            });
        }
    };

    function startConnection(id) {
        if(conn) conn.close();
        conn = peer.connect(id);
        setupEvents();
    }

    document.getElementById('peer-id').onkeypress = (e) => {
        if (e.key === 'Enter' && e.target.value) {
            const target = e.target.value.trim().toLowerCase();
            if(target === myNick) return alert("Это ваш ник!");
            startConnection(target);
            e.target.value = '';
        }
    };

    function setupEvents() {
        conn.on('open', () => {
            document.getElementById('h-name').innerText = "Защищенный чат: " + conn.peer;
            if(!friends.includes(conn.peer)) {
                friends.push(conn.peer);
                localStorage.setItem('contacts_' + myNick, JSON.stringify(friends));
                render();
            }
            msgBox.innerHTML = "";
            addMessage("Канал связи открыт.", 'in');
        });

        conn.on('data', (encryptedData) => {
            const password = keyInp.value || "default_123";
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedData, password);
                const originalText = bytes.toString(CryptoJS.enc.Utf8);
                if (originalText) {
                    addMessage(originalText, 'in');
                } else {
                    addMessage("[!] Ошибка: Неверный ключ шифрования.", 'in');
                }
            } catch(e) {
                addMessage("[!] Ошибка расшифровки.", 'in');
            }
        });
    }

    function addMessage(text, type) {
        const m = document.createElement('div');
        m.className = 'm ' + type;
        m.innerText = text;
        msgBox.appendChild(m);
        msgBox.scrollTop = msgBox.scrollHeight;
    }

    function send() {
        const input = document.getElementById('m-in');
        const password = keyInp.value || "default_123";
        if(!input.value || !conn) return;
        const encrypted = CryptoJS.AES.encrypt(input.value, password).toString();
        conn.send(encrypted);
        addMessage(input.value, 'out');
        input.value = "";
    }

    document.getElementById('m-in').onkeypress = (e) => { if(e.key === 'Enter') send(); };
</script>
</body>
</html>
