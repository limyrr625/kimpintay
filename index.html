<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KIMPINTAY MESSENGER</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <style>
        :root { --p: #7b61ff; --bg: #0b0b0e; --panel: #16161e; --success: #00ff88; --text: #e0e0e0; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; height: 100vh; overflow: hidden; }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { position: fixed; inset: 0; display: flex; flex-direction: column; transition: 0.3s; background: var(--bg); z-index: 10; }
        .screen.hidden { transform: translateY(100%); opacity: 0; pointer-events: none; }

        /* –í—Ö–æ–¥ */
        .login-screen { justify-content: center; align-items: center; padding: 40px; z-index: 100; }
        .login-card { background: var(--panel); padding: 30px; border-radius: 24px; width: 100%; max-width: 350px; border: 1px solid #333; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }

        /* –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω */
        .main-app { display: flex; flex-direction: row; }
        .sidebar { width: 350px; background: var(--panel); border-right: 1px solid #222; display: flex; flex-direction: column; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #08080a; }

        /* –ö–æ–Ω—Ç–∞–∫—Ç—ã */
        .contact-item { padding: 15px 20px; border-bottom: 1px solid #222; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .contact-item:hover { background: #20202a; }
        .fire { font-size: 18px; filter: grayscale(1); opacity: 0.2; }
        .fire.online { filter: grayscale(0) hue-rotate(240deg); opacity: 1; text-shadow: 0 0 10px var(--p); }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .msgs { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .bubble { padding: 12px 18px; border-radius: 20px; max-width: 75%; font-size: 15px; position: relative; line-height: 1.4; }
        .bubble.in { background: #222; align-self: flex-start; border-bottom-left-radius: 4px; }
        .bubble.out { background: var(--p); align-self: flex-end; border-bottom-right-radius: 4px; color: white; }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
        input { background: #1a1a22; border: 1px solid #333; color: white; padding: 15px; border-radius: 14px; width: 100%; outline: none; margin-bottom: 10px; font-size: 16px; }
        button { background: var(--p); border: none; color: white; padding: 15px; border-radius: 14px; cursor: pointer; font-weight: bold; font-size: 16px; width: 100%; }
        .send-area { padding: 20px; background: var(--panel); display: flex; gap: 10px; }

        /* –°—Ç–∞—Ç—É—Å –ø–ª–∞—à–∫–∞ */
        .status-bar { padding: 10px 20px; font-size: 12px; display: flex; align-items: center; gap: 8px; background: #000; border-bottom: 1px solid #222; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #444; }
        .dot.online { background: var(--success); box-shadow: 0 0 8px var(--success); }

        @media (max-width: 768px) { 
            .sidebar { width: 100%; } 
            .chat-area { position: fixed; inset: 0; z-index: 50; transform: translateX(100%); transition: 0.3s; }
            .chat-area.active { transform: translateX(0); }
        }
    </style>
</head>
<body>

    <div id="login-scr" class="screen login-screen">
        <div class="login-card">
            <h2 style="text-align:center; color:var(--p); margin-bottom:30px">KIMPINTAY</h2>
            <input type="text" id="nick" placeholder="–ù–∏–∫–Ω–µ–π–º">
            <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="initializeApp()">–í–û–ô–¢–ò –í –ê–ö–ö–ê–£–ù–¢</button>
            <p id="err" style="color:red; font-size:12px; text-align:center; margin-top:10px"></p>
        </div>
    </div>

    <div id="main-scr" class="screen main-app hidden">
        <div class="sidebar">
            <div class="status-bar">
                <div id="my-dot" class="dot"></div>
                <span id="my-id-label">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
            </div>
            <div style="padding:15px">
                <input type="text" id="add-id" placeholder="ID –¥—Ä—É–≥–∞" style="margin:0; font-size:13px; padding:10px">
                <button onclick="addFriend()" style="margin-top:5px; padding:8px; font-size:12px">–î–û–ë–ê–í–ò–¢–¨</button>
            </div>
            <div id="contacts-list" style="overflow-y:auto; flex:1"></div>
        </div>

        <div id="chat-win" class="chat-area">
            <div style="padding:15px; background:var(--panel); border-bottom:1px solid #222; display:flex; align-items:center; gap:15px">
                <button onclick="closeChat()" style="width:auto; padding:5px 12px; background:#222; display:none" id="back">‚Üê</button>
                <b id="target-name">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</b>
            </div>
            <div id="msgs" class="msgs"></div>
            <div class="send-area">
                <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
                <button onclick="sendMsg()" style="width:60px">‚û§</button>
            </div>
        </div>
    </div>

<script>
    let peer = null, conn = null, contacts = [];

    // 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø (–ö–ê–ö –í –ü–†–ò–õ–û–ñ–ï–ù–ò–ò)
    function initializeApp() {
        const nick = document.getElementById('nick').value.trim().toLowerCase();
        const pass = document.getElementById('pass').value.trim();
        if(!nick || !pass) return;

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID
        const myId = 'kp-' + nick;

        peer = new Peer(myId);

        peer.on('open', (id) => {
            document.getElementById('login-scr').classList.add('hidden');
            document.getElementById('main-scr').classList.remove('hidden');
            document.getElementById('my-dot').classList.add('online');
            document.getElementById('my-id-label').innerText = "ONLINE: " + id;
            loadContacts();
        });

        peer.on('connection', (c) => {
            conn = c;
            setupEvents();
        });

        peer.on('error', (e) => {
            document.getElementById('err').innerText = "–û—à–∏–±–∫–∞: –í–æ–∑–º–æ–∂–Ω–æ, –Ω–∏–∫ –∑–∞–Ω—è—Ç";
        });
    }

    // 2. –†–ê–ë–û–¢–ê –° –ö–û–ù–¢–ê–ö–¢–ê–ú–ò
    function addFriend() {
        const id = document.getElementById('add-id').value.trim();
        if(id.startsWith('kp-') && !contacts.includes(id)) {
            contacts.push(id);
            localStorage.setItem('kp_app_contacts', JSON.stringify(contacts));
            renderContacts();
        }
    }

    function renderContacts() {
        const list = document.getElementById('contacts-list');
        list.innerHTML = '';
        contacts.forEach(id => {
            const div = document.createElement('div');
            div.className = 'contact-item';
            div.innerHTML = `<b>${id.toUpperCase()}</b> <span class="fire" id="fire-${id}">üî•</span>`;
            div.onclick = () => {
                if(window.innerWidth <= 768) {
                    document.getElementById('chat-win').classList.add('active');
                    document.getElementById('back').style.display = 'block';
                }
                if(conn) conn.close();
                conn = peer.connect(id);
                setupEvents();
            };
            list.appendChild(div);
        });
    }

    function setupEvents() {
        conn.on('open', () => {
            document.getElementById('target-name').innerText = conn.peer;
            const f = document.getElementById('fire-' + conn.peer);
            if(f) f.classList.add('online');
        });
        conn.on('data', d => addBubble(d, 'in'));
    }

    function loadContacts() {
        contacts = JSON.parse(localStorage.getItem('kp_app_contacts')) || [];
        renderContacts();
    }

    // 3. –û–¢–ü–†–ê–í–ö–ê
    function sendMsg() {
        const i = document.getElementById('msg-input');
        if(i.value && conn && conn.open) {
            conn.send(i.value);
            addBubble(i.value, 'out');
            i.value = "";
        }
    }

    function addBubble(text, type) {
        const d = document.createElement('div');
        d.className = 'bubble ' + type;
        d.innerText = text;
        document.getElementById('msgs').appendChild(d);
        document.getElementById('msgs').scrollTop = 99999;
    }

    function closeChat() { document.getElementById('chat-win').classList.remove('active'); }
</script>
</body>
</html>
