<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KIMPINTAY</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <style>
        :root { --p: #7b61ff; --bg: #0b0b0e; --panel: #16161e; --success: #00ff88; --text: #e0e0e0; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0; 
            height: 100vh; 
            overflow: hidden; 
        }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { position: fixed; inset: 0; display: flex; flex-direction: column; background: var(--bg); transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 10; }
        .screen.hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }

        /* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è */
        .auth-card { background: var(--panel); padding: 40px 30px; border-radius: 30px; width: 90%; max-width: 400px; margin: auto; border: 1px solid #333; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        /* –ì–ª–∞–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .app-layout { display: flex; height: 100vh; width: 100vw; }
        .sidebar { width: 350px; background: var(--panel); border-right: 1px solid #222; display: flex; flex-direction: column; }
        .chat-view { flex: 1; display: flex; flex-direction: column; background: #08080a; }

        /* –ö–æ–Ω—Ç–∞–∫—Ç—ã */
        .contact-item { padding: 18px 20px; border-bottom: 1px solid #1a1a1a; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .contact-item:active { background: #20202a; }
        .online-fire { font-size: 20px; filter: grayscale(1); opacity: 0.2; }
        .online-fire.active { filter: grayscale(0) hue-rotate(240deg); opacity: 1; text-shadow: 0 0 10px var(--p); }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .messages-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .bubble { padding: 12px 16px; border-radius: 20px; max-width: 80%; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .bubble.in { background: #25252b; align-self: flex-start; border-bottom-left-radius: 4px; }
        .bubble.out { background: var(--p); align-self: flex-end; border-bottom-right-radius: 4px; color: white; }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        input { background: #1a1a22; border: 1px solid #333; color: white; padding: 15px; border-radius: 15px; width: 100%; font-size: 16px; margin-bottom: 12px; transition: 0.3s; }
        input:focus { border-color: var(--p); }
        button { background: var(--p); border: none; color: white; padding: 15px; border-radius: 15px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; }
        button:active { transform: scale(0.97); opacity: 0.8; }

        .input-bar { padding: 20px; background: var(--panel); display: flex; gap: 10px; padding-bottom: calc(20px + env(safe-area-inset-bottom)); }

        @media (max-width: 768px) {
            .sidebar { width: 100%; }
            .chat-view { position: fixed; inset: 0; transform: translateX(100%); z-index: 20; }
            .chat-view.open { transform: translateX(0); }
        }
    </style>
</head>
<body>

    <div id="scr-auth" class="screen">
        <div class="auth-card">
            <h1 style="color:var(--p); margin:0 0 10px 0; letter-spacing: 2px;">KIMPINTAY</h1>
            <p style="color:#666; font-size:14px; margin-bottom:30px;">Messenger App v1.0</p>
            <input type="text" id="inp-nick" placeholder="–ù–∏–∫–Ω–µ–π–º">
            <input type="password" id="inp-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="handleAuth()" style="width:100%">–í–û–ô–¢–ò –í –ê–ö–ö–ê–£–ù–¢</button>
            <p id="auth-err" style="color:#ff4444; font-size:12px; margin-top:15px;"></p>
        </div>
    </div>

    <div id="scr-main" class="screen hidden">
        <div class="app-layout">
            <div class="sidebar">
                <div style="padding:25px; display:flex; justify-content:space-between; align-items:center;">
                    <b id="display-name" style="font-size:20px;"></b>
                    <button onclick="logout()" style="padding:5px 10px; font-size:10px; background:#331111; color:red; width:auto;">–í–´–ô–¢–ò</button>
                </div>
                <div style="padding:0 20px 20px 20px;">
                    <input type="text" id="inp-friend" placeholder="ID –¥—Ä—É–≥–∞ (kp-...)" style="margin:0; font-size:13px;">
                    <button onclick="addFriend()" style="width:100%; margin-top:10px; padding:10px; font-size:13px;">–î–û–ë–ê–í–ò–¢–¨ –ö–û–ù–¢–ê–ö–¢</button>
                </div>
                <div id="contact-list" style="flex:1; overflow-y:auto;"></div>
            </div>

            <div id="chat-win" class="chat-view">
                <div style="padding:15px 20px; background:#111; border-bottom:1px solid #222; display:flex; align-items:center; gap:15px;">
                    <button onclick="closeChat()" id="btn-back" style="width:auto; padding:5px 12px; background:#222; display:none;">‚Üê</button>
                    <b id="chat-with">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</b>
                </div>
                <div id="msg-box" class="messages-container"></div>
                <div class="input-bar">
                    <input type="text" id="inp-msg" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0;">
                    <button onclick="send()" style="width:60px;">‚û§</button>
                </div>
            </div>
        </div>
    </div>

<script>
    let peer = null, conn = null, currentUser = null;
    let storage = JSON.parse(localStorage.getItem('kp_data')) || {};

    function handleAuth() {
        const nick = document.getElementById('inp-nick').value.trim().toLowerCase();
        const pass = document.getElementById('inp-pass').value.trim();
        if(!nick || !pass) return;

        if(storage[nick]) {
            if(storage[nick].pass !== pass) {
                document.getElementById('auth-err').innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!";
                return;
            }
        } else {
            storage[nick] = { pass: pass, contacts: [], history: {} };
            save();
        }

        currentUser = nick;
        startNetwork();
    }

    function startNetwork() {
        peer = new Peer('kp-' + currentUser);
        peer.on('open', (id) => {
            document.getElementById('scr-auth').classList.add('hidden');
            document.getElementById('scr-main').classList.remove('hidden');
            document.getElementById('display-name').innerText = currentUser.toUpperCase();
            renderContacts();
        });
        peer.on('connection', (c) => {
            conn = c;
            c.on('data', data => handleIncoming(c.peer, data));
        });
        peer.on('error', () => document.getElementById('auth-err').innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ ID –∑–∞–Ω—è—Ç");
    }

    function addFriend() {
        const id = document.getElementById('inp-friend').value.trim();
        if(id.startsWith('kp-') && !storage[currentUser].contacts.includes(id)) {
            storage[currentUser].contacts.push(id);
            save();
            renderContacts();
            document.getElementById('inp-friend').value = "";
        }
    }

    function renderContacts() {
        const list = document.getElementById('contact-list');
        list.innerHTML = '';
        storage[currentUser].contacts.forEach(id => {
            const div = document.createElement('div');
            div.className = 'contact-item';
            div.innerHTML = `<b>${id.toUpperCase()}</b> <span class="online-fire" id="fire-${id}">üî•</span>`;
            div.onclick = () => openChat(id);
            list.appendChild(div);
        });
    }

    function openChat(id) {
        if(window.innerWidth <= 768) {
            document.getElementById('chat-win').classList.add('open');
            document.getElementById('btn-back').style.display = 'block';
        }
        document.getElementById('chat-with').innerText = id.toUpperCase();
        if(conn) conn.close();
        conn = peer.connect(id);
        conn.on('open', () => document.getElementById('fire-'+id).classList.add('active'));
        conn.on('data', data => handleIncoming(id, data));
        loadHistory(id);
    }

    function handleIncoming(senderId, data) {
        if(!storage[currentUser].history[senderId]) storage[currentUser].history[senderId] = [];
        storage[currentUser].history[senderId].push({ text: data, type: 'in' });
        save();
        if(document.getElementById('chat-with').innerText === senderId.toUpperCase()) {
            addBubble(data, 'in');
        }
    }

    function send() {
        const inp = document.getElementById('inp-msg');
        if(inp.value && conn && conn.open) {
            const txt = inp.value;
            const target = conn.peer;
            conn.send(txt);
            if(!storage[currentUser].history[target]) storage[currentUser].history[target] = [];
            storage[currentUser].history[target].push({ text: txt, type: 'out' });
            save();
            addBubble(txt, 'out');
            inp.value = "";
        }
    }

    function addBubble(text, type) {
        const d = document.createElement('div');
        d.className = 'bubble ' + type;
        d.innerText = text;
        const box = document.getElementById('msg-box');
        box.appendChild(d);
        box.scrollTop = box.scrollHeight;
    }

    function loadHistory(id) {
        const box = document.getElementById('msg-box');
        box.innerHTML = '';
        (storage[currentUser].history[id] || []).forEach(m => addBubble(m.text, m.type));
    }

    function save() { localStorage.setItem('kp_data', JSON.stringify(storage)); }
    function logout() { location.reload(); }
    function closeChat() { document.getElementById('chat-win').classList.remove('open'); }
</script>
</body>
</html>
